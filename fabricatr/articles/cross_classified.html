<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Aaron Rudkin">
<title>DeclareDesign - Panel and Cross-classified data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<script src="../../site_libs/quarto-nav/quarto-nav.js"></script><script src="../../site_libs/quarto-nav/headroom.min.js"></script><script src="../../site_libs/clipboard/clipboard.min.js"></script><script src="../../site_libs/quarto-search/autocomplete.umd.js"></script><script src="../../site_libs/quarto-search/fuse.min.js"></script><script src="../../site_libs/quarto-search/quarto-search.js"></script><meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script><script src="../../site_libs/quarto-html/popper.min.js"></script><script src="../../site_libs/quarto-html/tippy.umd.min.js"></script><script src="../../site_libs/quarto-html/anchor.min.js"></script><link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script><link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <img src="../../static/dd-logo-sm.svg" alt=""><span class="navbar-title"><strong>Declare</strong>Design</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../getting-started.html">Getting started</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://book.declaredesign.org">Book</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-software" role="button" data-bs-toggle="dropdown" aria-expanded="false">Software</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-software">
<li>
    <a class="dropdown-item" href="../../declaredesign/">
 <span class="dropdown-text">DeclareDesign</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../fabricatr/">
 <span class="dropdown-text">fabricatr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../randomizr/">
 <span class="dropdown-text">randomizr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../estimatr/">
 <span class="dropdown-text">estimatr</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Panel and Cross-classified data</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Aaron Rudkin </p>
          </div>
  </div>
    
    
  </div>
  

</header><div class="cell">

</div>
<p>Although much of <strong>fabricatr</strong>’s is designed to generate hierarchical, nested data, we also provide functions to generate panel and cross-classified (partially nested) data. In this vignette, we offer instructions to do both.</p>
<section id="panel-data-construction" class="level2"><h2 class="anchored" data-anchor-id="panel-data-construction">Panel Data Construction</h2>
<p>Let’s begin by visualizing an example of panel data, where we have data for each of several countries in each of several years.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="cross_classified_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>This data arrangement is somewhat more complex than traditional nested, hierarchical data. Each observation draws from a common pool of countries and years. In other words, the year-specific variables attached to Country A’s 1997 observation are also attached to Country B’s 1997 observation.</p>
<p>The steps for generating a panel in <strong>fabricatr</strong> are as follows:</p>
<ol type="1">
<li>Generate multiple non-nested data frames (Countries and Years)</li>
<li>Use the <code><a href="//reference/cross_levels.html">cross_levels()</a></code> function to join the non-nested data frames to make a panel.</li>
<li>Optionally, add new variables or further levels in the resulting cross-classified data. (Observation-level variables)</li>
</ol>
<section id="generating-multiple-non-nested-levels-in-fabricatr" class="level3"><h3 class="anchored" data-anchor-id="generating-multiple-non-nested-levels-in-fabricatr">Generating multiple, non-nested levels in <strong>fabricatr</strong>
</h3>
<p>First, we need to generate country and year data. By default, <strong>fabricatr</strong> fully nests subsequent levels under the first level call. Here, we must explicitly not do this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">panels</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  countries <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">150</span>, country_fe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  years <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">25</span>, year_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>Note that this function call will not evaluate because we have specified the two non-nested data frames, but not yet told <strong>fabricatr</strong> what to do with them. The second (and any subsequent) non-nested levels should contain the <code>nest = FALSE</code> argument – otherwise, years would be interpreted as to be a level nested within countries. Each level will track all of its own variables, so it is possible to add as many features as you would like to the levels.</p>
</section><section id="importing-non-nested-data-frames" class="level3"><h3 class="anchored" data-anchor-id="importing-non-nested-data-frames">Importing non-nested data frames</h3>
<p>It is also possible to import multiple non-nested data frames; this will allow you to assemble pre-existing data sources however you would like. Recall that the first argument to a <code><a href="//reference/fabricate.html">fabricate()</a></code> call is the data you wish to import. We have previously seen that it is possible to import a single data frame this way, but it is also possible to import a list of data frames, staging them all for use for cross-classifying data. Data imported in this manner looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">data_frame_1</span>, <span class="va">data_frame_2</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>Again, the <code><a href="//reference/fabricate.html">fabricate()</a></code> call is incomplete – we have imported the data we wish to cross-classify on, but not yet learned how to merge the data. If you do not specify how to merge the data, <code><a href="//reference/fabricate.html">fabricate()</a></code> will simply return the most recent data frame imported or generated, unmodified.</p>
</section><section id="specifying-a-merge-function" class="level3"><h3 class="anchored" data-anchor-id="specifying-a-merge-function">Specifying a merge function</h3>
<p>Specifying a merge function to create a panel is simple. You need only to tell <strong>fabricatr</strong> which levels you wish to merge, and then you will have an assembled panel and can generate new variables at the observation-level. We do this using a call to <code><a href="//reference/cross_levels.html">cross_levels()</a></code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">panels</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  countries <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">150</span>, country_fe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  years <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">25</span>, year_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  obs <span class="op">=</span> <span class="fu"><a href="//reference/cross_levels.html">cross_levels</a></span><span class="op">(</span></span>
<span>    by <span class="op">=</span> <span class="fu"><a href="//reference/join_using.html">join_using</a></span><span class="op">(</span><span class="va">countries</span>, <span class="va">years</span><span class="op">)</span>,</span>
<span>    new_variable <span class="op">=</span> <span class="va">country_fe</span> <span class="op">+</span> <span class="va">year_shock</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>Note that <code><a href="//reference/cross_levels.html">cross_levels()</a></code> takes a single required argument, which is of the form <code>by = join_using(...)</code>. This join_using command tells <strong>fabricatr</strong> how to assemble your data. In this case, we are telling it to join the countries data frame to the years data frame, resulting in country-year observations.</p>
<p>Just like with regular <code><a href="//reference/fabricate.html">add_level()</a></code> commands, you can add new variables which have full access to the existing columns.</p>
</section></section><section id="cross-classified-or-correlated-data-joins" class="level2"><h2 class="anchored" data-anchor-id="cross-classified-or-correlated-data-joins">Cross-Classified or Correlated Data Joins:</h2>
<p>Another type of data <strong>fabricatr</strong> excels at enabling is cross-classified data. In a cross-classified dataset, just like in a panel, observations draw from a combination of multiple existing data sets. Our example in this vignette will be students. Students attend a primary school and a secondary school. Unlike in a panel, not every student attends every school; and not every combination of schools has exactly one student. Student outcomes depend both on primary and secondary school education.</p>
<p>Let’s begin by visualizing how our data will be laid out:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="cross_classified_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>The main steps involved in generating cross-classified data are as follows:</p>
<ol type="1">
<li>Generate multiple non-nested data frames (Primary and Secondary Schools)</li>
<li>Use the <code><a href="//reference/cross_levels.html">link_levels()</a></code> function to join the non-nested data frames on <em>particular variables</em>, optionally specifying a desired correlation outcome.</li>
<li>Optionally, add new variables or further levels in the resulting cross-classified data. (Student-level characteristics)</li>
</ol>
<p>We have already learned above how to generate multiple non-nested data frames; now we example how to specify a merge function for cross-classified data.</p>
<section id="specifying-a-merge-function-for-cross-classified-data." class="level3"><h3 class="anchored" data-anchor-id="specifying-a-merge-function-for-cross-classified-data.">Specifying a merge function for cross-classified data.</h3>
<p>One difference between panel data and cross-classified data is that we need to specify the number of observations we will create by combining the existing levels of data. For example, there may be 20 primary schools and 15 secondary schools in a mid-sized city, but several thousand students. Specifying this is as easy as providing an <code>N</code> argument to the <code><a href="//reference/cross_levels.html">link_levels()</a></code> call. At this juncture, we will assume there is no relationship between the primary school a student attends and the secondary school a student attends.</p>
<p>Our model generates primary schools and secondary schools, each of which have a quality variable associated with them (<code>ps_quality</code> for primary schools, and <code>ss_quality</code> for secondary schools):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">schools_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  primary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">20</span>, ps_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  secondary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">15</span>, ss_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  students <span class="op">=</span> <span class="fu"><a href="//reference/cross_levels.html">link_levels</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1500</span>, by <span class="op">=</span> <span class="fu"><a href="//reference/join_using.html">join_using</a></span><span class="op">(</span><span class="va">primary_schools</span>, <span class="va">secondary_schools</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>We see that compared to generating a panel, the only change is to switch the joining function to <code><a href="//reference/cross_levels.html">link_levels()</a></code> and adding an <code>N</code> argument. The result is, predictably, a data frame containing 1500 observations, each of five columns: primary_schools (ID), ps_quality, secondary_schools (ID), ss_quality, and students (ID).</p>
</section><section id="adding-additional-variables" class="level3"><h3 class="anchored" data-anchor-id="adding-additional-variables">Adding additional variables</h3>
<p>As shown above, it is simple to add variables to the new, cross-classified data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">schools_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  primary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">20</span>, ps_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  secondary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">15</span>, ss_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  students <span class="op">=</span> <span class="fu"><a href="//reference/cross_levels.html">link_levels</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1500</span>, by <span class="op">=</span> <span class="fu"><a href="//reference/join_using.html">join_using</a></span><span class="op">(</span><span class="va">primary_schools</span>, <span class="va">secondary_schools</span><span class="op">)</span>,</span>
<span>    SAT_score <span class="op">=</span> <span class="fl">800</span> <span class="op">+</span> <span class="fl">13</span> <span class="op">*</span> <span class="va">ps_quality</span> <span class="op">+</span> <span class="fl">26</span> <span class="op">*</span> <span class="va">ss_quality</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>Here, each student is assigned a standardized testing score, equal to a baseline, plus an additive effect from the quality of their primary school, plus a large additive effect from the quality of their secondary school, plus a stochastic component.</p>
<p>A linear regression confirms that the resulting data approximately reflects the the data generating process:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">SAT_score</span> <span class="op">~</span> <span class="va">ps_quality</span> <span class="op">+</span> <span class="va">ss_quality</span>, data <span class="op">=</span> <span class="va">schools_data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead><tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">Std. Error</th>
<th style="text-align: right;">t value</th>
<th style="text-align: right;">Pr(&gt;|t|)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">800</td>
<td style="text-align: right;">4.12</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">ps_quality</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ss_quality</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">0.44</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Other variables can be added in the <em>students</em> level, or indeed in either of the component levels.</p>
</section><section id="correlations-after-merging" class="level3"><h3 class="anchored" data-anchor-id="correlations-after-merging">Correlations after merging</h3>
<p>A variety of R packages support functionality for joining data in various ways. However, a key feature of <strong>fabricatr</strong> is that it is possible to generate <em>correlated</em> cross-classified data. Above, we assumed that the primary school a student attended has no relationship to the secondary school the same student attends. This assumption does not reflect actual patterns in the social world. We might, for example, reasonably assume that students assigned to better primary schools are later assigned to better secondary schools – whether due to economic geography of the area, selective admissions, or other causes. It is easy to specify a correlation between these outcomes using much the same syntax we used before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corr_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  primary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">20</span>, ps_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  secondary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">15</span>, ss_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  students <span class="op">=</span> <span class="fu"><a href="//reference/cross_levels.html">link_levels</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1500</span>, by <span class="op">=</span> <span class="fu"><a href="//reference/join_using.html">join_using</a></span><span class="op">(</span><span class="va">ps_quality</span>, <span class="va">ss_quality</span>, rho <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    SAT_score <span class="op">=</span> <span class="fl">800</span> <span class="op">+</span> <span class="fl">13</span> <span class="op">*</span> <span class="va">ps_quality</span> <span class="op">+</span> <span class="fl">26</span> <span class="op">*</span> <span class="va">ss_quality</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`link_levels()` calls are faster if the `mvnfast` package is installed.</code></pre>
</div>
</div>
<p>Here, we have changed the structure of our <code><a href="//reference/join_using.html">join_using()</a></code> function call. First, the variables we are joining on are <code>ps_quality</code> and <code>ss_quality</code>. <strong>fabricatr</strong> locates these variables within the data frames they come from. Second we specify a Spearman’s (rank) correlation coefficient, <code>rho</code>, which will induce a correlation in the resulting data based on the join_using function. In this case, we want a correlation between <code>ps_quality</code> and <code>ss_quality</code> of 0.5.</p>
<p>Technical details of the implementation of this function are contained below, but in the mean time the important thing to note is that <code>rho</code> can be any value from -1 to 1, and that the resulting correlation will be approximately equal to <code>rho</code>.</p>
<p><em>Note: Because of the technical details of our implementation, the true correlation in the resulting data will be slightly attenuated (smaller in magnitude) from the specified <code>rho</code>. There is no general purpose correction to compensate for this attenuation.</em></p>
<p>We can check the resulting correlation here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">corr_data</span><span class="op">$</span><span class="va">ps_quality</span>, <span class="va">corr_data</span><span class="op">$</span><span class="va">ss_quality</span><span class="op">)</span></span></code></pre></div>
</div>
<p>0.43</p>
<p>It should be noted that the specified correlation exists only within the variables on which a join was specified: other variables from either data source will not be explicitly connected except through the joined variables.</p>
<p>Correlation is only possible for cross-classified data, not panel data.</p>
</section></section><section id="joining-more-than-two-levels" class="level2"><h2 class="anchored" data-anchor-id="joining-more-than-two-levels">Joining more than two levels</h2>
<p>All of the functions specified above work when joining more than two levels. We could extend our student example to include, for example, college quality. Nothing changes about the join syntax beyond the addition of the third or subsequent variable names:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">three_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  primary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">20</span>, ps_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  secondary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">15</span>, ss_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  colleges <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">50</span>, c_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  students <span class="op">=</span> <span class="fu"><a href="//reference/cross_levels.html">link_levels</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1500</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="//reference/join_using.html">join_using</a></span><span class="op">(</span></span>
<span>      <span class="va">ps_quality</span>, <span class="va">ss_quality</span>, <span class="va">c_quality</span>,</span>
<span>      rho <span class="op">=</span> <span class="fl">0.2</span></span>
<span>    <span class="op">)</span>,</span>
<span>    earning_potential <span class="op">=</span> <span class="fl">20000</span> <span class="op">+</span> <span class="op">(</span><span class="fl">2000</span> <span class="op">*</span> <span class="va">ps_quality</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="fl">6000</span> <span class="op">*</span> <span class="va">ss_quality</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">10000</span> <span class="op">*</span> <span class="va">c_quality</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">5000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`link_levels()` calls are faster if the `mvnfast` package is installed.</code></pre>
</div>
</div>
<p>One potential source for failure is specifying an invalid <code>rho</code>. If you specify a <code>rho</code> that makes the correlation between the three variables impossible to obtain, the <code><a href="//reference/fabricate.html">fabricate()</a></code> call will fail. A common case of this occurring is specifying a negative <code>rho</code> with three or more levels – in general, if A is negatively correlated with B, and B is negatively correlated with C, then A and C cannot be negatively correlated.</p>
<p>Instead of specifying a <code>rho</code> correlation coefficient, users can specify a <code>sigma</code> correlation matrix to make the resulting correlations more sophisticated. Consider the following setup:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>,</span>
<span>    <span class="fl">0.4</span>, <span class="fl">1</span>, <span class="fl">0.8</span>,</span>
<span>    <span class="fl">0.2</span>, <span class="fl">0.8</span>, <span class="fl">1</span></span>
<span>  <span class="op">)</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">3</span>, nrow <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">adv_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="//reference/fabricate.html">fabricate</a></span><span class="op">(</span></span>
<span>  primary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">20</span>, ps_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  secondary_schools <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">15</span>, ss_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  colleges <span class="op">=</span> <span class="fu"><a href="//reference/fabricate.html">add_level</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">50</span>, c_quality <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  students <span class="op">=</span> <span class="fu"><a href="//reference/cross_levels.html">link_levels</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1500</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="//reference/join_using.html">join_using</a></span><span class="op">(</span></span>
<span>      <span class="va">ps_quality</span>, <span class="va">ss_quality</span>, <span class="va">c_quality</span>,</span>
<span>      sigma <span class="op">=</span> <span class="va">sigma</span></span>
<span>    <span class="op">)</span>,</span>
<span>    earning_potential <span class="op">=</span> <span class="fl">20000</span> <span class="op">+</span> <span class="op">(</span><span class="fl">2000</span> <span class="op">*</span> <span class="va">ps_quality</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="fl">6000</span> <span class="op">*</span> <span class="va">ss_quality</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">10000</span> <span class="op">*</span> <span class="va">c_quality</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">5000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`link_levels()` calls are faster if the `mvnfast` package is installed.</code></pre>
</div>
</div>
<p><code>sigma</code> must be specified as a symmetric square matrix with a diagonal of all 1s and a feasible correlation structure.</p>
</section><section id="technical-appendix-implementation-of-correlated-joins." class="level2"><h2 class="anchored" data-anchor-id="technical-appendix-implementation-of-correlated-joins.">Technical appendix: Implementation of correlated joins.</h2>
<p>The implementation of the correlated join is done via the Gaussian copula. Mathematically, what is occurring is as follows:</p>
<ol type="1">
<li>User specifies a correlation structure.</li>
<li>Draw multivariate standard normal data with that correlation structure.</li>
<li>Transform the standard normal data for each dimension to quantiles of the standard normal cumulative distribution function.</li>
<li>Take the data from the source distribution at the empirical quantile equal to the quantiles from step 3. This ensures that the data being joined on have a Spearman’s (rank) correlation coefficient as specified in the multivariate standard normal draw.</li>
<li>Map the data chosen back to a row from the source distribution and join that row to the chosen row from the other source distributions, ensuring that all covariates are put in the resulting merged data.</li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body>
</html>
